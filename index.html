<html>
	<script src="js/vec3.js"></script>
	<style>
		body {
			display: flex;
			justify-content: center;
			align-items: center;
		}

		#container {
			width: 20em;
			height: 20em;
			border: solid black;
			display: flex;
			justify-content: center;  
			align-items: center;
		}

		#card {
			width: 5em;
			height: 7em;
			position: relative;
		}

		#card-item {
			width: 100%;
			height: 100%;
			position: relative;
		}

		#glare {
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
		}

		#card-bg {
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
		}

		#shadow {
			position: absolute;
			background: radial-gradient(#000000FF, #00000000);
			width: 100%;
			height: 100%;
			top:0;
			left: 0;
			transform: translate(-3px, 3px);
			border-radius: 5px;
		}
	</style>
	<body>
		<div id='container'>
			<div id="card">
				<div id="shadow"></div>
				<div id = 'card-item'>
					<img id="card-bg" src="TestCard.png"></img>
					<img id='glare' src="TestGlare.png"></img>
				</div>
			</div>
		</div>
	</body>

	<script>
		let container = document.getElementById('container');
		let card = document.getElementById('card-item');
		let glare = document.getElementById('glare');
		let shadow = document.getElementById('shadow');
		let time = 0;
		
		function getElementCoord(elem) {
			let box = elem.getBoundingClientRect();

			return {
				top: box.top + window.pageYOffset,
				right: box.right + window.pageXOffset,
				bottom: box.bottom + window.pageYOffset,
				left: box.left + window.pageXOffset,
				centerX: box.left + window.pageXOffset + (box.right - box.left) / 2,
				centerY: box.top + window.pageYOffset + (box.bottom - box.top) / 2,
				width: box.right - box.left,
				height: box.top - box.bottom,
			};
		}

		var containerRect = getElementCoord(container);
		const cursorSimHeight = 220;
		const lightDirection = (new vec3(.65, -1, .5)).normalize();

		const shadowDistance = 5;
		const shadowXFactor = lightDirection.dot(new vec3(-1, 0, 0));
		const shadowYFactor = lightDirection.dot(new vec3(0, -1, 0));
		const shadowOffset = {x : shadowDistance * shadowXFactor, y : shadowDistance * shadowYFactor};
		
		console.log(`lightDirection ${JSON.stringify(lightDirection)}`);

		container.addEventListener('mousemove',(ev)=>{
			const evPosition = { x : ev.clientX - containerRect.centerX, y : ev.clientY - containerRect.centerY};
			const atanX = Math.atan2(Math.abs(evPosition.x), cursorSimHeight);
			const angleX = evPosition.x === 0 ? 0 : evPosition.x > 0 ? atanX : -atanX;
			const atanY = Math.atan2(Math.abs(evPosition.y), cursorSimHeight);
			const angleY = evPosition.y === 0 ? 0 : evPosition.y > 0 ? -atanY : atanY;

			const sinX = Math.sin(angleX);
			const cosX = Math.cos(angleX);
			const sinY = Math.sin(angleY);
			const cosY = Math.cos(angleY);

			const normal = new vec3(sinX, -sinY * cosX, cosX * cosY);
			console.log(normal);
			const li = Math.pow(normal.dot(lightDirection), 4);

			console.log(`normal:${JSON.stringify(normal)}, li:${li}`);

			card.style.transform = `rotateY(${angleX}rad) rotateX(${angleY}rad)`;
			shadow.style.transform = `rotateY(${angleX}rad) rotateX(${angleY}rad) translate(${shadowOffset.x}px, ${shadowOffset.y}px)`;
			glare.style.opacity = `${li * 100}%`;
		});
	</script>
</html>